<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Education Inequality Narrative Visualization</title>
  <!-- D3 and d3-annotation -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; }
    #controls { margin-bottom: 10px; }
    button { padding: 6px 12px; margin-right: 5px; }
    .tooltip {
      position: absolute;
      text-align: left;
      width: auto;
      padding: 8px;
      font-size: 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>How Funding, Staffing & Socioeconomic Status Relate to Test Scores</h1>
  <div id="controls">
    <button id="prevBtn">Previous</button>
    <button id="nextBtn">Next</button>
  </div>
  <div id="viz"></div>

  <!-- CSV Data -->
  <!-- Make sure education_inequality_data.csv is in the same directory -->

  <!-- Inline Narrative Script -->
  <script>
  // Global parameters
  let currentSlide = 1;
  let data;

  // SVG setup
  const margin = { top: 40, right: 20, bottom: 50, left: 60 };
  const width = 800 - margin.left - margin.right;
  const height = 500 - margin.top - margin.bottom;

  // Create container
  const svg = d3
    .select('#viz')
    .append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
    .append('g')
    .attr('transform', `translate(${margin.left},${margin.top})`);

  // Tooltip
  const tooltip = d3
    .select('body')
    .append('div')
    .attr('class', 'tooltip')
    .style('opacity', 0);

  // Load data
  d3.csv('education_inequality_data.csv', d3.autoType).then(raw => {
    data = raw;
    init();
  });

  // Initialize controls and first slide
  function init() {
    d3.select('#prevBtn').on('click', () => {
      if (currentSlide > 1) {
        currentSlide--;
        updateSlide();
      }
    });

    d3.select('#nextBtn').on('click', () => {
      if (currentSlide < 3) {
        currentSlide++;
        updateSlide();
      }
    });

    updateSlide();
  }

  // Update the visualization based on currentSlide
  function updateSlide() {
    svg.selectAll('*').remove();

    switch (currentSlide) {
      case 1:
        drawFundingScene();
        break;
      case 2:
        drawRatioScene();
        break;
      case 3:
        drawIncomeScene();
        break;
    }
  }

  // Draw a generic scatterplot
  function drawScatter(xKey, yKey, xLabel, yLabel) {
    // Scales
    const x = d3.scaleLinear()
      .domain(d3.extent(data, d => d[xKey]))
      .nice()
      .range([0, width]);

    const y = d3.scaleLinear()
      .domain(d3.extent(data, d => d[yKey]))
      .nice()
      .range([height, 0]);

    // Axes
    svg.append('g')
      .attr('transform', `translate(0,${height})`)
      .call(d3.axisBottom(x));

    svg.append('g')
      .call(d3.axisLeft(y));

    // Labels
    svg.append('text')
      .attr('x', width / 2)
      .attr('y', height + margin.bottom - 10)
      .attr('text-anchor', 'middle')
      .text(xLabel);

    svg.append('text')
      .attr('transform', 'rotate(-90)')
      .attr('x', -height / 2)
      .attr('y', -margin.left + 15)
      .attr('text-anchor', 'middle')
      .text(yLabel);

    // Points
    svg.selectAll('circle')
      .data(data)
      .enter()
      .append('circle')
      .attr('cx', d => x(d[xKey]))
      .attr('cy', d => y(d[yKey]))
      .attr('r', 4)
      .attr('fill', '#ff7f0e')
      .attr('opacity', 0.7)
      .on('mouseover', (event, d) => {
        tooltip.transition().duration(200).style('opacity', 0.9);
        tooltip
          .html(`<strong>${d.school_name}</strong><br/>${xLabel}: ${d[xKey]}<br/>${yLabel}: ${d[yKey]}`)
          .style('left', `${event.pageX + 10}px`)
          .style('top', `${event.pageY - 28}px`);
      })
      .on('mouseout', () => {
        tooltip.transition().duration(500).style('opacity', 0);
      });

    return { x, y };
  }

  // Scene 1: Funding vs. Test Score
  function drawFundingScene() {
    const { x, y } = drawScatter(
      'funding_per_student_usd',
      'avg_test_score_percent',
      'Funding per Student (USD)',
      'Average Test Score (%)'
    );

    // Annotation
    const ann1 = d3.annotation()
      .type(d3.annotationLabel)
      .annotations([
        {
          note: { label: 'No clear trend: correlation ≈ 0', title: 'Funding vs. Score' },
          x: x(15000),
          y: y(85),
          dx: 40,
          dy: -30
        }
      ]);

    svg.append('g').call(ann1);
  }

  // Scene 2: Student–Teacher Ratio vs. Test Score
  function drawRatioScene() {
    const { x, y } = drawScatter(
      'student_teacher_ratio',
      'avg_test_score_percent',
      'Student–Teacher Ratio',
      'Average Test Score (%)'
    );

    // Annotation
    const ann2 = d3.annotation()
      .type(d3.annotationLabel)
      .annotations([
        {
          note: { label: 'Some low-ratio schools score high', title: 'Ratio vs. Score' },
          x: x(12),
          y: y(95),
          dx: -60,
          dy: -40
        }
      ]);

    svg.append('g').call(ann2);
  }

  // Scene 3: % Low-Income vs. Test Score
  function drawIncomeScene() {
    const { x, y } = drawScatter(
      'percent_low_income',
      'avg_test_score_percent',
      'Percent Low-Income (%)',
      'Average Test Score (%)'
    );

    // Annotation
    const ann3 = d3.annotation()
      .type(d3.annotationLabel)
      .annotations([
        {
          note: { label: 'No strong inverse relationship', title: 'Income vs. Score' },
          x: x(60),
          y: y(75),
          dx: 50,
          dy: 30
        }
      ]);

    svg.append('g').call(ann3);
  }
  </script>
</body>
</html>
